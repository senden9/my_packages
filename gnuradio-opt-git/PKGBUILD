# Maintainer: Stefano Probst <senden9@gmail.com>
# based on https://aur.archlinux.org/packages/gnuradio-git/
pkgname=gnuradio-opt-git
_gitname=gnuradio
pkgver=v3.7.4.113.gdb2c447
pkgrel=1
pkgdesc="Free software development toolkit that provides the signal processing runtime and processing blocks to implement software radios. This package install Gnuradio to /opt. So you can install GnuRadio parallel with GnuRadio-git."
arch=('i686' 'x86_64')
license=('GPL')
depends=('fftw' 'python2-numpy' 'cppunit' 'swig' 'gsl' 'blas' 'guile' 'boost-libs' 'libuhd' 'libusbx' 'portaudio')
makedepends=('git' 'boost' 'cmake')
optdepends=('wxpython: gr-wxgui' 'python2-cheetah: grc' 'python2-lxml: grc' 'qwtplot3d: gr-qtgui' 'doxygen: docs autogenerated documentation' 'pyxml: grc' 'pygtk: grc' 'pkgconfig' 'pyqwt: gr-qtgui')
provides=('gnuradio')
url="http://gnuradio.org"
source=("git://github.com/gnuradio/gnuradio.git" "setupenv")
md5sums=('SKIP'
         '2d9d3b09b28b768251b4f8745d3764d6')
install=gnuradio-opt-git.install
_installPath="/opt/gnuradio"

pkgver() {
	cd ${srcdir}/$_gitname
	git describe --always | sed 's|-|.|g'
}

build() {
	export PYTHON=python2
	cd ${srcdir}/$_gitname
	msg "Starting build."
	mkdir -p build
	cd build
	cmake \
		-DPYTHON_EXECUTABLE=$(which python2) \
		-DPYTHON_INCLUDE_DIR=$(echo /usr/include/python2*) \
		-DPYTHON_LIBRARY=$(echo /usr/lib/libpython2.*.so) \
		-DCMAKE_INSTALL_PREFIX=$_installPath ..
	make
}

check() {
	cd ${srcdir}/$_gitname/build
	export PYTHON=python2
	#Build from git. Sometimes check fails. If so, comment out the following line.
	make test
}

package() {
	cd ${srcdir}/$_gitname/build
	make DESTDIR=${pkgdir} install
	msg "Replacing filenames to use python2."
	sed -i -e "s|#![ ]*/usr/bin/env python$|#!/usr/bin/env python2|" $(find $pkgdir -name '*.py') $(find $pkgdir -name 'gnuradio-companion' -o -name 'flow_graph.tmpl')
	install $startdir/setupenv $pkgdir/$_installPath/setupenv
}

